import{r as x,j as t}from"./framer-motion-DexFYn3r.js";import{s as C,B as S,S as b,a as w}from"./index-o6bm3qdW.js";import{A as $,a as z,b as M}from"./alert-BZO_YP9D.js";import{C as E}from"./checkbox-CElA_Qfn.js";import{C as L,a as v,c as q,b as _}from"./card-CGU5HWmE.js";import{g as R,a as G,f as N,e as k}from"./es-DGeWnv4b.js";import{T}from"./terminal-RUzjgFnx.js";import{e as A}from"./endOfWeek-CdErONJX.js";import"./index-B3hHUwxe.js";import"./check-BwO51OGf.js";const D=s=>{if(!s)return null;const n=s.toLowerCase().trim();return{g:"g",gr:"g",gramo:"g",gramos:"g",kg:"kg",kilo:"kg",kilos:"kg",kilogramo:"kg",kilogramos:"kg",l:"l",litro:"l",litros:"l",ml:"ml",mililitro:"ml",mililitros:"ml",taza:"taza",tazas:"taza",cucharada:"cda",cucharadas:"cda",cda:"cda",cdas:"cda",cucharadita:"cdita",cucharaditas:"cdita",cdita:"cdita",cditas:"cdita",unidad:"unidad",unidades:"unidad",diente:"diente",dientes:"diente",cabeza:"cabeza",cabezas:"cabeza",paquete:"paquete",paquetes:"paquete",lata:"lata",latas:"lata",botella:"botella",botellas:"botella",pizca:"pizca",pizcas:"pizca"}[n]||n},F=s=>{if(s==null)return null;if(typeof s=="number")return isNaN(s)?null:s;if(typeof s!="string")return null;const n=s.trim();if(n==="")return null;const i=parseFloat(n);if(!isNaN(i))return i;if(n.includes("/")){const c=n.split("/");if(c.length===2){const l=parseFloat(c[0]),u=parseFloat(c[1]);if(!isNaN(l)&&!isNaN(u)&&u!==0)return l/u}}if(n.includes("-")){const c=n.split("-");if(c.length>=1){const l=parseFloat(c[0]);if(!isNaN(l))return l}}return null};async function P(s){const{data:n,error:i}=await C.from("recipes").select(`
            *,
            recipe_ingredients (
                name,
                quantity,
                unit
            )
        `).eq("id",s).single();return i?(console.error(`Error fetching recipe ${s}:`,i),null):n}async function O(s,n){console.log(`Generando lista de compras para ${s} a ${n}`);let i=[];try{i=await R(s,n),console.log(`Se encontraron ${i.length} comidas planificadas.`)}catch(e){throw console.error("Error obteniendo comidas planificadas:",e),new Error("No se pudieron obtener las comidas planificadas.")}if(i.length===0)return[];const c=i.map(e=>e.recipe_id).filter(e=>!!e),l=[...new Set(c)],u=l.map(e=>P(e)),y=await Promise.allSettled(u),p=new Map;y.forEach((e,o)=>{e.status==="fulfilled"&&e.value?p.set(l[o],e.value):console.warn(`No se pudo cargar la receta con ID ${l[o]}:`,e.status==="rejected"?e.reason:"Resultado nulo")}),console.log(`Se cargaron ${p.size} recetas únicas.`);const g=[];i.forEach(e=>{if(e.recipe_id&&p.has(e.recipe_id)){const o=p.get(e.recipe_id);o&&o.recipe_ingredients&&o.recipe_ingredients.forEach(m=>{m.name&&g.push({name:m.name,quantity:m.quantity,unit:m.unit,recipeName:o.name||"Receta sin nombre"})})}else e.custom_meal_name&&console.log(`Ignorando comida personalizada: ${e.custom_meal_name}`)}),console.log(`Se extrajeron ${g.length} ingredientes crudos en total.`);const h=new Map;g.forEach(e=>{const o=e.name.trim().toLowerCase(),m=D(e.unit),a=F(e.quantity),d=`${o}|${m||"unidad"}`;let r=h.get(d);r?(r.quantity!==null&&a!==null?r.quantity+=a:r.quantity=null,e.recipeName&&!r.recipeSources.includes(e.recipeName)&&r.recipeSources.push(e.recipeName)):r={id:d,ingredientName:e.name.trim(),quantity:a,unit:m,isChecked:!1,recipeSources:e.recipeName?[e.recipeName]:[]},h.set(d,r)}),console.log(`Se agregaron ${h.size} ítems únicos en la lista.`);const f=Array.from(h.values());return f.sort((e,o)=>e.ingredientName.localeCompare(o.ingredientName)),f}function Y(){const[s,n]=x.useState([]),[i,c]=x.useState(!1),[l,u]=x.useState(null),[y,p]=x.useState(null),g=new Date,h=G(g,{weekStartsOn:1}),f=A(g,{weekStartsOn:1}),e=x.useCallback(async()=>{c(!0),u(null),n([]),p(null);const a=N(h,"yyyy-MM-dd"),d=N(f,"yyyy-MM-dd");try{const r=await O(a,d);n(r.map(j=>({...j,isChecked:!1}))),p({start:a,end:d})}catch(r){console.error("Error generating shopping list:",r),u(r.message||"Error inesperado al generar la lista.")}finally{c(!1)}},[h,f]),o=a=>{n(d=>d.map(r=>r.id===a?{...r,isChecked:!r.isChecked}:r))},m=a=>{if(!a)return"";try{const d=new Date(a.start+"T00:00:00"),r=new Date(a.end+"T00:00:00");return`para la semana del ${N(d,"d MMM",{locale:k})} al ${N(r,"d MMM yyyy",{locale:k})}`}catch{return`para ${a.start} a ${a.end}`}};return t.jsxs("div",{className:"container mx-auto max-w-2xl py-8 px-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Lista de Compras"}),t.jsxs(S,{onClick:e,disabled:i,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:[i?t.jsx(b,{size:"sm",className:"mr-2"}):t.jsx(w,{className:"mr-2 h-4 w-4"}),"Generar Lista (Semana Actual)"]})]}),l&&t.jsxs($,{variant:"destructive",className:"mb-6",children:[t.jsx(T,{className:"h-4 w-4"}),t.jsx(z,{children:"Error"}),t.jsx(M,{children:l})]}),t.jsxs(L,{className:"bg-white border border-slate-200 shadow-md rounded-lg",children:[t.jsx(v,{children:t.jsx(q,{className:"text-slate-900",children:s.length>0?`Lista Generada ${m(y)}`:"Genera tu lista"})}),t.jsxs(_,{children:[i&&t.jsx("div",{className:"flex justify-center items-center h-40",children:t.jsx(b,{})}),!i&&s.length===0&&!l&&t.jsx("p",{className:"text-center text-slate-500 py-10",children:'Haz clic en "Generar Lista" para ver los ingredientes necesarios para tus comidas planificadas de esta semana.'}),!i&&s.length>0&&t.jsx("ul",{className:"space-y-2",children:s.map(a=>t.jsxs("li",{className:"flex items-center space-x-3 p-2 border-b border-slate-100 last:border-b-0",children:[t.jsx(E,{id:`item-${a.id}`,checked:a.isChecked,onCheckedChange:()=>o(a.id),"aria-label":`Marcar ${a.ingredientName}`}),t.jsxs("div",{className:"flex-grow",children:[t.jsx("label",{htmlFor:`item-${a.id}`,className:`text-sm font-medium ${a.isChecked?"text-slate-400 line-through":"text-slate-800"}`,children:a.ingredientName}),(a.quantity!==null||a.unit)&&t.jsxs("span",{className:`ml-2 text-xs ${a.isChecked?"text-slate-400 line-through":"text-slate-500"}`,children:["(",a.quantity??""," ",a.unit??"",")"]})]})]},a.id))})]})]})]})}export{Y as ShoppingListPage};
