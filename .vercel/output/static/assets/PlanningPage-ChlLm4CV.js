import{r as d,j as e}from"./framer-motion-DexFYn3r.js";import{c as Y,B as S,S as Q,h as N,L as Se,u as ke,o as De,C as Ce}from"./index-o6bm3qdW.js";import{t as H,c as ce,s as ne,f as p,e as W,g as Pe,a as X,u as oe,d as Ee}from"./es-DGeWnv4b.js";import{a as _e}from"./generationService-C6CJkpBz.js";import{g as Ae}from"./userService-CZh88SKG.js";import{D as Oe,a as ze,b as $e,c as Le,d as Re,e as Ie}from"./dialog-C1OzTA5U.js";import{S as Fe,a as We,b as qe,c as Be,d as le}from"./select-DBfGXf_6.js";import{I as Te}from"./input-DTFkI6V9.js";import{L as ie}from"./label-Ctjrl553.js";import{S as de}from"./sparkles-CmyYQTht.js";import{P as Ve}from"./pencil-DTPZJ6bb.js";import{T as Ge}from"./trash-2-CpjvPaTx.js";import{P as Ue}from"./plus-DaImIilD.js";import{e as He}from"./endOfWeek-CdErONJX.js";import"./pantryService-1OnSk01a.js";import"./index-zM9kQwqA.js";import"./index-BMd2TyCU.js";import"./index-B3hHUwxe.js";import"./chevron-down-D8MEcRXF.js";import"./check-BwO51OGf.js";import"./chevron-up-DGjrEF3Z.js";/**
 * @license lucide-react v0.320.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=Y("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-react v0.320.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=Y("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);/**
 * @license lucide-react v0.320.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=Y("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);function me(a,u){const n=H(a);return isNaN(u)?ce(a,NaN):(u&&n.setDate(n.getDate()+u),n)}function Xe(a){return ce(a,Date.now())}function Ye(a,u){const n=ne(a),c=ne(u);return+n==+c}function Ze(a,u){const n=H(a.start),c=H(a.end);let i=+n>+c;const x=i?+n:+c,f=i?c:n;f.setHours(0,0,0,0);let g=1;const m=[];for(;+f<=x;)m.push(H(f)),f.setDate(f.getDate()+g),f.setHours(0,0,0,0);return i?m.reverse():m}function q(a){return Ye(a,Xe(a))}function et(a,u){return me(a,-7)}const tt={Desayuno:"Desayuno",Almuerzo:"Almuerzo",Merienda:"Merienda",Cena:"Cena"};function rt({isOpen:a,onClose:u,date:n,mealType:c,mealToEdit:i,userRecipes:x,onSave:f,onRequestAlternatives:g}){const[m,o]=d.useState(""),[y,P]=d.useState(""),[k,B]=d.useState(!1),[z,D]=d.useState(null),[w,$]=d.useState(null),[C,L]=d.useState(!1),E=!!i;d.useEffect(()=>{a&&(D(null),E&&i?(o(i.recipe_id||""),P(i.custom_meal_name||"")):(o(""),P("")),$(null),L(!1))},[a,E,i]);const G=async()=>{if(!n||!c)return;B(!0),D(null);const l={plan_date:p(n,"yyyy-MM-dd"),meal_type:c,recipe_id:m||null,custom_meal_name:m?null:y.trim()||null};if(!l.recipe_id&&!l.custom_meal_name){D("Debes seleccionar una receta o escribir un nombre de comida."),B(!1);return}try{await f(l,i==null?void 0:i.id)}catch(j){D("Error al guardar la comida."),console.error("Error saving meal:",j)}finally{B(!1)}},_=async()=>{if(!c||!m&&!y.trim())return;L(!0),$(null),D(null);const l={meal_type:c,recipe_id:m||null,custom_meal_name:y.trim()||null};try{const j=await g(l);$(j),!j||j.length}catch(j){console.error("Error requesting alternatives:",j),D("Error al buscar alternativas.")}finally{L(!1)}},M=l=>{l.type==="recipe"?(o(l.id),P("")):(P(l.text),o("")),$(null)};return e.jsx(Oe,{open:a,onOpenChange:l=>!l&&u(),children:e.jsxs(ze,{"aria-describedby":"meal-form-description",children:[e.jsxs($e,{children:[e.jsxs("div",{id:"meal-form-description",className:"sr-only",children:["Formulario para ",E?"editar":"añadir"," una comida planificada"]}),e.jsxs(Le,{children:[E?"Editar Comida":"Añadir Comida",n&&c&&e.jsxs("span",{className:"block text-sm font-normal text-muted-foreground",children:[tt[c]??c," - ",p(n,"eeee d MMM",{locale:W})]})]})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx(ie,{htmlFor:"recipe-select",children:"Seleccionar Receta (Opcional)"}),e.jsxs(Fe,{value:m,onValueChange:l=>{o(l==="_none"?"":l),l!=="_none"&&P("")},disabled:k,children:[e.jsx(We,{id:"recipe-select",children:e.jsx(qe,{placeholder:"Elige una receta..."})}),e.jsxs(Be,{children:[e.jsx(le,{value:"_none",children:"-- Ninguna --"}),x.map(l=>e.jsx(le,{value:l.id,children:l.title},l.id))]})]})]}),e.jsx("div",{className:"text-center text-sm text-muted-foreground",children:"O"}),e.jsxs("div",{children:[e.jsx(ie,{htmlFor:"custom-meal",children:"Escribir Nombre de Comida"}),e.jsx(Te,{id:"custom-meal",value:y,onChange:l=>{P(l.target.value),l.target.value&&o("")},placeholder:"Ej: Milanesas con puré",disabled:k})]}),z&&e.jsx("p",{className:"text-sm text-red-500 mt-2",children:z}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-border/20",children:[e.jsxs(S,{type:"button",variant:"outline",size:"sm",className:"w-full",onClick:_,disabled:k||C||!m&&!y.trim(),children:[e.jsx(de,{className:"mr-2 h-4 w-4"}),C?"Buscando...":"Buscar Alternativas"]}),C&&e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(Q,{size:"sm"})}),w&&w.length>0&&e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Sugerencias:"}),e.jsx("ul",{className:"max-h-32 overflow-y-auto rounded-md border border-border/30 bg-muted/30 p-2",children:w.map((l,j)=>e.jsx("li",{children:e.jsx("button",{type:"button",className:"w-full text-left p-2 text-sm rounded hover:bg-primary/10 text-foreground/90",onClick:()=>M(l),children:l.type==="recipe"?l.title:l.text})},j))})]}),w&&w.length===0&&!C&&e.jsx("p",{className:"mt-3 text-sm text-center text-muted-foreground",children:"No se encontraron alternativas."})]})]}),e.jsxs(Re,{children:[e.jsx(Ie,{asChild:!0,children:e.jsx(S,{type:"button",variant:"outline",disabled:k,children:"Cancelar"})}),e.jsx(S,{type:"button",onClick:G,disabled:k,children:k?"Guardando...":"Guardar"})]})]})})}function at({days:a,selectedDay:u,onDaySelect:n,className:c}){const i=p(u,"yyyy-MM-dd");return e.jsx("div",{className:N("flex items-stretch justify-between p-1 gap-1","bg-card/80 backdrop-blur-sm rounded-lg border border-border/30",c),children:a.map(x=>{const f=p(x,"yyyy-MM-dd"),g=f===i,m=q(x);return e.jsxs("button",{onClick:()=>n(x),className:N("flex-1 flex flex-col items-center justify-center py-1.5 px-1","rounded-md transition-all duration-300","hover:bg-muted/50",g&&"bg-primary/10 text-primary ring-1 ring-primary/20",!g&&m&&"ring-1 ring-primary/10","min-w-[3rem]"),children:[e.jsx("span",{className:N("text-xs font-medium mb-1",g?"text-primary":"text-foreground/70"),children:p(x,"EEE",{locale:W})}),e.jsx("span",{className:N("w-7 h-7 flex items-center justify-center rounded-full text-sm transition-colors",g?"bg-primary/20 font-medium":"text-muted-foreground",m&&!g&&"bg-primary/5"),children:p(x,"d")}),m&&!g&&e.jsx("span",{className:"mt-1 w-1 h-1 rounded-full bg-primary/40"})]},f)})})}const st={Desayuno:{emoji:"🍳",label:"Desayuno"},Almuerzo:{emoji:"🥗",label:"Almuerzo"},Merienda:{emoji:"🫖",label:"Merienda"},Cena:{emoji:"🌙",label:"Cena"}};function ue({date:a,mealType:u,plannedMeals:n,onAddClick:c,onEditClick:i,onDeleteClick:x,className:f}){const g=st[u],m=n&&n.length>0;return e.jsxs("div",{className:N("flex flex-col h-full p-1.5",f),children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1.5 flex-shrink-0",children:[e.jsx("span",{className:"text-sm select-none",children:g.emoji}),e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:g.label})]}),e.jsx("div",{className:"flex-grow overflow-y-auto min-h-0 pr-1 space-y-1 mb-1",children:m?n.map(o=>e.jsxs("div",{className:N("bg-background/60 rounded px-1.5 py-1 text-left relative group border border-transparent","hover:bg-background/80 hover:border-border/20 transition-colors","cursor-pointer"),onClick:()=>i(o),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs text-foreground line-clamp-1 flex-grow pr-1",children:o.recipes?o.recipes.name:o.custom_meal_name||"Comida"}),o.recipe_id&&o.recipes&&e.jsx(Se,{to:`/app/recipes/${o.recipe_id}`,onClick:y=>y.stopPropagation(),className:"text-muted-foreground opacity-0 group-hover:opacity-100 flex-shrink-0 ml-1 hover:text-[hsl(var(--primary))] transition-all duration-200","aria-label":"Ver receta",children:e.jsx(Qe,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-0 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(S,{variant:"ghost",size:"icon",className:"h-5 w-5 hover:bg-background/80 text-muted-foreground hover:text-[hsl(var(--primary))] transition-all duration-200",onClick:y=>{y.stopPropagation(),i(o)},title:"Editar comida",children:e.jsx(Ve,{className:"w-3 h-3"})}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-5 w-5 hover:bg-background/80 text-muted-foreground hover:text-[hsl(var(--destructive))] transition-all duration-200",onClick:y=>{y.stopPropagation(),window.confirm("¿Eliminar esta comida planificada?")&&x(o.id)},"aria-label":"Eliminar comida",children:e.jsx(Ge,{className:"h-3 w-3"})})]})]},o.id)):e.jsx("div",{className:"text-xs text-muted-foreground/70 text-center h-full flex items-center justify-center italic",children:"Vacío"})}),e.jsx(S,{variant:"ghost",size:"sm",className:"w-full h-6 text-xs rounded-md border-t border-border/10 hover:bg-muted/30 mt-auto flex-shrink-0 -mx-1.5 -mb-1.5",onClick:()=>c(a,u),children:e.jsx(Ue,{className:"h-3.5 w-3.5"})})]})}function nt({date:a,mealsByType:u,mealTypes:n,onAddClick:c,onEditClick:i,onDeleteClick:x,showHeader:f=!0,className:g}){return e.jsxs("div",{className:N("flex flex-col space-y-2",g),children:[f&&e.jsx("div",{className:N("p-2 text-center rounded-lg","bg-card border border-border/30","transition-colors duration-300",q(a)?"bg-primary/5 border-primary/20":"hover:bg-muted/50"),children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-foreground/80 capitalize",children:p(a,"EEEE",{locale:W})}),e.jsx("div",{className:N("flex items-center justify-center rounded-full w-6 h-6 text-xs",q(a)?"bg-primary/10 text-primary font-medium ring-1 ring-primary/10":"text-muted-foreground"),children:p(a,"d")})]})}),n.map(m=>{const o=u[m]||[];return e.jsx(ue,{date:a,mealType:m,plannedMeals:o,onAddClick:c,onEditClick:i,onDeleteClick:x},m)})]})}const ot=a=>{const u=X(a,{weekStartsOn:1}),n=He(a,{weekStartsOn:1});return{start:u,end:n}};function Ct(){const[a,u]=d.useState(new Date),[n,c]=d.useState(new Date),[i,x]=d.useState([]),[f,g]=d.useState(!0),[m,o]=d.useState(null),y=[],[P,k]=d.useState(null),[B,z]=d.useState(!1),[D,w]=d.useState(null),[$,C]=d.useState(null),[L,E]=d.useState(!1),[G,_]=d.useState(null),{user:M}=ke(),j=De()!=="mobile",{start:T,end:V}=ot(a),R=Ze({start:T,end:V}),U=d.useMemo(()=>{const t={};return i.forEach(r=>{const s=r.plan_date;t[s]||(t[s]={}),t[s][r.meal_type]||(t[s][r.meal_type]=[]),t[s][r.meal_type].push(r)}),t},[i]),Z=d.useCallback(async(t,r)=>{g(!0),o(null);try{const s=p(t,"yyyy-MM-dd"),v=p(r,"yyyy-MM-dd"),[b]=await Promise.all([Pe(s,v),Promise.resolve([])]);x(b)}catch(s){o("Error al cargar datos de planificación o recetas."),console.error("[PlanningPage] Error loading data:",s)}finally{g(!1)}},[]),pe=d.useMemo(()=>p(T,"yyyy-MM-dd"),[T]),xe=d.useMemo(()=>p(V,"yyyy-MM-dd"),[V]);d.useEffect(()=>{Z(T,V)},[pe,xe,Z]),d.useEffect(()=>{(async()=>{if(M){const r=await Ae(M.id);k(r)}})()},[M]);const fe=()=>{const t=et(a);u(t);const r=new Date,s=X(t,{weekStartsOn:1});c(s<r?s:q(s)?r:s)},ge=()=>{const t=me(a,7);u(t),c(X(t,{weekStartsOn:1}))},ee=(t,r)=>{c(t),w(r),C(null),z(!0)},te=t=>{const r=new Date(t.plan_date+"T00:00:00");c(r),w(t.meal_type),C(t),z(!0)},re=()=>{z(!1),C(null),w(null)},he=async(t,r)=>{o(null);try{const s=await oe(t,r);if(s){const v=["Desayuno","Almuerzo","Merienda","Cena"];x(r?i.map(b=>b.id===r?s:b):[...i,s].sort((b,A)=>b.plan_date.localeCompare(A.plan_date)||v.indexOf(b.meal_type)-v.indexOf(A.meal_type))),re()}else throw new Error("La operación de guardado no devolvió una comida válida.")}catch(s){throw console.error("Error saving meal:",s),o(`Error al guardar: ${s instanceof Error?s.message:"Error desconocido"}`),s}},ae=async t=>{o(null);try{await Ee(t)?x(i.filter(s=>s.id!==t)):o("No se pudo eliminar la comida.")}catch(r){console.error("Error deleting meal:",r),o("Error al eliminar la comida.")}},ye=async t=>(console.log("[PlanningPage] Requesting alternatives for:",t),null),be=async()=>{if(!(M!=null&&M.id)){_("Debes iniciar sesión para autocompletar la semana.");return}E(!0),_(null),o(null);const t=7;try{console.log(`[PlanningPage] Iniciando autocompletado para ${t} recetas...`);const r=await _e(t,M.id);if(console.log("[PlanningPage] Resultado de generación:",r),r.errors.length>0){const s=r.errors[0].message;_(`Error generando recetas: ${s}${r.errors.length>1?` (y ${r.errors.length-1} más)`:""}`)}if(r.successfulRecipes.length>0){console.log(`[PlanningPage] ${r.successfulRecipes.length} recetas generadas con éxito. Guardando en planificación...`);const s="Cena",v=[];r.successfulRecipes.forEach((h,I)=>{if(I<R.length){const O=R[I],F=p(O,"yyyy-MM-dd"),K={plan_date:F,meal_type:s,custom_meal_name:h.title,notes:h.description,recipe_id:null};console.log(`[PlanningPage] Preparando para guardar comida para ${F} - ${s}: ${h.title}`),v.push(oe(K))}});const b=await Promise.allSettled(v);console.log("[PlanningPage] Resultados de guardar comidas:",b);const A=[];let J=0;if(b.forEach((h,I)=>{h.status==="fulfilled"&&h.value?A.push(h.value):(J++,console.error(`[PlanningPage] Error guardando comida ${I+1}:`,h.status==="rejected"?h.reason:"Resultado nulo"))}),A.length>0){console.log(`[PlanningPage] ${A.length} comidas añadidas/actualizadas con éxito.`);const h=["Desayuno","Almuerzo","Merienda","Cena"],I=[...i.filter(O=>!R.some((K,Me)=>p(K,"yyyy-MM-dd")===O.plan_date&&O.meal_type===s&&Me<r.successfulRecipes.length)),...A].sort((O,F)=>O.plan_date.localeCompare(F.plan_date)||h.indexOf(O.meal_type)-h.indexOf(F.meal_type));x(I)}if(J>0){const h=G?`${G}. `:"";_(`${h}Ocurrieron ${J} error(es) al guardar las comidas en el planificador.`)}}else r.errors.length===t&&console.log("[PlanningPage] No se generó ninguna receta con éxito.")}catch(r){console.error("[PlanningPage] Error inesperado durante el autocompletado:",r),_(`Error inesperado: ${r.message||"Error desconocido"}`)}finally{E(!1),console.log("[PlanningPage] Proceso de autocompletado finalizado.")}},se=["Desayuno","Almuerzo","Merienda","Cena"],je=p(n,"yyyy-MM-dd"),ve=U?U[je]||{}:{},Ne=()=>e.jsxs("div",{className:"flex flex-col w-full space-y-3",children:[e.jsx(at,{days:R,selectedDay:n,onDaySelect:c,className:"mx-auto w-full max-w-md"}),e.jsx(nt,{date:n,mealsByType:ve,mealTypes:se,onAddClick:ee,onEditClick:te,onDeleteClick:ae,className:"max-w-md mx-auto w-full"})]}),we=()=>e.jsxs("div",{className:"grid grid-cols-7 grid-rows-[auto_repeat(4,auto)] gap-1 w-full max-w-[1200px] border border-border/20 rounded-lg overflow-hidden shadow-sm",children:[R.map(t=>e.jsx("div",{className:N("p-2 text-center border-b border-r border-border/10","bg-card",q(t)?"bg-primary/5":""),children:e.jsxs("div",{className:"text-sm font-medium text-foreground/90",children:[p(t,"eee",{locale:W}),e.jsx("div",{className:N("inline-flex items-center justify-center mt-1 rounded-full w-6 h-6 text-xs",q(t)?"bg-primary/10 text-primary font-medium ring-1 ring-primary/10":"text-muted-foreground"),children:p(t,"d")})]})},`header-${t.toISOString()}`)),R.flatMap(t=>{const r=p(t,"yyyy-MM-dd"),s=U?U[r]||{}:{};return se.map(v=>{const b=s[v]||[];return e.jsx("div",{className:"border-r border-b border-border/10 bg-card min-h-0",children:e.jsx(ue,{date:t,mealType:v,plannedMeals:b,onAddClick:ee,onEditClick:te,onDeleteClick:ae,className:"h-full"})},`${r}-${v}`)})})]});return e.jsxs("div",{className:"flex flex-col items-center w-full h-full px-2 py-3 mx-auto",children:[e.jsxs("div",{className:"flex flex-col items-center mb-4 w-full max-w-[1200px]",children:[e.jsx("div",{className:"flex items-center gap-2 p-1.5 bg-gradient-to-r from-card/80 via-background/60 to-card/80 rounded-lg shadow-sm border border-border/20 backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-xl font-bold text-foreground/90",children:"Planificación Semanal"})]})}),e.jsxs("div",{className:"flex items-center justify-center gap-2 mt-3",children:[e.jsx(S,{variant:"ghost",size:"sm",onClick:fe,className:"rounded-full h-7 w-7 p-0 hover:bg-background/70 hover:text-[hsl(var(--primary))] transition-all duration-200",children:e.jsx(Je,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-medium px-4 py-1 bg-background/50 rounded-full text-foreground/80",children:[p(T,"d MMM",{locale:W})," - ",p(V,"d MMM yyyy",{locale:W})]}),e.jsx(S,{variant:"ghost",size:"sm",onClick:ge,className:"rounded-full h-7 w-7 p-0 hover:bg-background/70 hover:text-[hsl(var(--primary))] transition-all duration-200",children:e.jsx(Ke,{className:"h-4 w-4"})})]}),e.jsxs(S,{variant:"secondary",size:"sm",onClick:be,disabled:L||f,className:"ml-4",children:[L?e.jsx(Q,{size:"sm",className:"mr-2"}):e.jsx(de,{className:"mr-2 h-4 w-4"}),"Autocompletar Semana"]})]}),m&&e.jsx("p",{className:"mb-3 text-red-500 text-center text-sm",children:m}),f?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(Q,{size:"lg"})}):j?we():Ne(),e.jsx(rt,{isOpen:B,onClose:re,date:n,mealType:D,mealToEdit:$,userRecipes:y,onSave:he,onRequestAlternatives:ye})]})}export{Ct as PlanningPage};
